sources:
  kafka_in:
    type: kafka
    bootstrap_servers: "localhost:9092"
    topics: ["raw_flows"]
    group_id: "vector-consumer"
    # No encoding field here in 0.48+
    # JSON is default codec for Kafka in recent versions

transforms:
  enrich_flows:
    type: remap
    inputs: ["kafka_in"]
    source: |
      # Clean and normalize field names
      .destinationTransportPort = del(.["destination TransportPort"])
      .latitude = del(.["latitude "])
      .destinationIPv4Address = del(.["destination IPv 714285714287"])
      .flow_duration_ms = to_int!(.["flow_duration_ms"])
      .flow_end_time = del(.["flow_end_time"])
      .octetDeltaCount = del(.["octet DeltaCount"])
      .iso_code = del(.["iso code"])
      .time_inserted_ns = del(.["time_inser ted_ns"])
      .datalink_vlan = del(.["datalink van"])
      .http_cert_start_ms = del(.["https certificatul FlowStartMilliseconds"])

      # Remove nulls or empty strings
      . = compact(.)
      
      # Enrich with timestamp info
      .date = format_timestamp!(now(), "%Y-%m-%d")
      .time_inserted_ns = to_unix_timestamp(now(), "nanoseconds")

sinks:
  kafka_out:
    type: kafka
    inputs: ["enrich_flows"]
    bootstrap_servers: "localhost:9092"
    topic: "enriched_flows"
    encoding:
      codec: json
